import { FolderSlug, stringToFolderSlug } from "types/objects/payloads/folders";
import { Type } from "@google/genai";

// todo do-not-ship turn this into Class

// Helper function to call Google Gemini Flash API
export async function getDestinationFolder({ emailAddress }: { emailAddress: string }): Promise<FolderSlug> {

  try {
    const response = await invokeGemini({
      model: "gemini-2.0-flash",
      prompt: (
        `Analyze this email address and categorize it into the most appropriate folder destination based on the sender's domain and typical email patterns.
        Email address to analyze: ${emailAddress}
        CATEGORIZATION RULES:
          - chats: *[Important] if its a real person then chats
          - calendar: Calendar service providers, meeting schedulers (calendly.com, google calendar, etc.)
          - purchases: *[Important] E-commerce sites, shopping confirmations, receipts (amazon, shopify, stripe receipts, etc.)
          - newsletters: Newsletter services, mailing lists, marketing content providers
          - promotions: Marketing emails, promotional offers, discount codes (NOT personal business)
          - wallet: *[Important] Digital wallet services, loyalty cards, membership cards, QR codes
          - banking: *[Important]Banks, credit unions, financial institutions, payment processors (NOT promotional)
          - travel: *[Important] Airlines, hotels, booking sites, actual travel confirmations (NOT travel promotions)
          - notifications: System notifications, password resets, account alerts, one-time alerts
          - business: *[Important] Business services, invoicing, accounting, stripe business emails, professional services
          - trash: Spam, unimportant automated emails, irrelevant content
          - archive: Default fallback if uncertain about category
        Return ONLY the folder destination enum value as a string. No explanation needed.`),

      responseMimeType: "text/x.enum",
      responseSchema: {
        type: Type.STRING,
        enum: Object.values(FolderSlug),
      }
    });

    const destinationFolder: FolderSlug = stringToFolderSlug({ folderString: response.candidates[0]?.content?.parts?.reduce((acc: string, part: { text: string }) => acc + part.text, "") ?? "" });
    return destinationFolder;
  } catch (error) {
    console.error(`Error ${error} AI processing emailAddress: ${emailAddress}`);
    return FolderSlug.archive;
  }
}
