import { zodResponseFormat } from "openai/helpers/zod";
import { Type } from "@google/genai";
import OpenAI from "openai";
import { z } from "zod";

const openai = new OpenAI();

export type MessageSlim = {
  name?: string | null;
  subject?: string | null;
  labelIds?: string[] | null;
  snippet?: string | null;
  payload?: string | null;
}

export type AIResponseSchema = {
  email: string;
  contactName?: string;
  phoneNumber?: string;
  realPerson: number;
  tags?: string[];
  industry?: string;
  contactRole?: string;
  company?: string;
  temperature?: "cold" | "warm" | "hot";
}

// todo do-not-ship turn this into Class

// Helper function to call Google Gemini Flash API
export async function analyzeContacts(messages: ({ email: string } & MessageSlim)[]): Promise<AIResponseSchema[] | null> {
  const promises = messages.map((message) => analyzeContact({ contact: message }));

  try {
    // Use Promise.all to process all API calls concurrently
    const firstCallResults: (AIResponseSchema | null)[] = await Promise.all(promises);
    const responses: AIResponseSchema[] = firstCallResults.filter((result): result is AIResponseSchema => result !== null);

    // Filter out null responses and return the valid ones
    return responses;
  } catch (error) {
    console.error('Error in Promise.all for Gemini Flash API:', error);
    return null;
  }
}

export const analyzeContact = async ({ contact }: { contact: ({ email: string } & MessageSlim) }): Promise<AIResponseSchema | null> => {
  try {
    const response = await invokeGemini({
      model: 'gemini-2.0-flash',
      prompt: `
Analyze this Email Message Info and classify the contact type.

CRITICAL: Most emails are NOT from real people. Be very strict about what counts as a real person.

NOT REAL PEOPLE (realPerson should be 0):
- Any email containing "noreply", "no-reply", "donotreply" 
- Newsletters, promotions, marketing emails
- Automated notifications (booking confirmations, password resets, etc.)
- Service emails (support@, info@, hello@, contact@, admin@, etc.)
- Travel confirmations, receipts, order updates
- Social media notifications
- Company announcements or updates
- Any automated system messages

REAL PEOPLE (realPerson should be 1):
- Personal emails from individuals with personal email addresses
- Direct business communication from specific named individuals
- Replies to conversations you initiated with a real person

Email to analyze: ${JSON.stringify(contact)}
        `,
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          contactName: {
            type: Type.STRING,
            nullable: true,
            description: "ONLY if parts of the name are INCLUDED in the email address. Try to get the contactName from the Message I give you. Guess if you have to. But make sure the name you give is actually INCLUDED in the email address. If you don't know, this is a nullable field."
          },
          phoneNumber: {
            type: Type.STRING,
            nullable: true,
            description: "Phone number if available"
          },
          realPerson: {
            type: Type.NUMBER,
            description: "1 if this is definitely a real person sending a personal/direct business email. 0 if this is automated, promotional, newsletter, service email, or any non-personal communication. BE VERY STRICT - most emails should be 0."
          },
          tags: {
            type: Type.ARRAY,
            items: {
              type: Type.STRING
            },
            nullable: true,
            description: "Relevant tags for this email contact"
          },
          industry: {
            type: Type.STRING,
            nullable: true,
            description: "Industry if determinable from domain"
          },
          contactRole: {
            type: Type.STRING,
            nullable: true,
            description: "Job Role if determinable from email prefix"
          },
          company: {
            type: Type.STRING,
            nullable: true,
            description: "Company name if determinable from domain"
          }
        },
        required: ["realPerson"],
        propertyOrdering: [
          "contactName",
          "phoneNumber",
          "realPerson",
          "tags",
          "industry",
          "contactRole",
          "company",
        ]
      }
    })
    const text = response.candidates[0]?.content?.parts?.reduce((acc: string, part: { text: string }) => acc + part.text, "");
    if (text) {
      const parsedResponse = JSON.parse(text);
      // Ensure the email from the input message is included in the response
      return { ...parsedResponse, email: contact.email };
    }
    return null;
  } catch (error) {
    console.error(`Error AI processing email ${contact.email}:`, error);
    return null;
  }
}

export const getOpenAiContactSummary = async ({ message }: { message: { email: string } & MessageSlim }) => {
  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: `Analyze this Email Message Info and provide information using the schema guidelines: ${JSON.stringify(message)}`
        },
      ],
      response_format: zodResponseFormat(AIContactResponse, "ai-contact-response"),
    });

    const responseContent = completion.choices[0]?.message?.content;
    if (!responseContent) {
      return null;
    }

    const parsedResponse = AIContactResponse.parse(JSON.parse(responseContent));
    return {
      ...parsedResponse,
    }

  } catch (error) {
    console.log("ERROR: ", error);
    return null;
  }
}

const AIContactResponse = z.object({
  contactName: z.string().optional().describe("If unknown, null.Try to get the contactName from the Message I give you. Guess if you know, but if you do not know, do not answer."),
  tags: z.string().array().describe("Relevant tags for this email contact: for example promotional, person chat, real estate etc."),
  phoneNumber: z.string().optional().describe("If unknown, null. Phone number if available"),
  realPerson: z.number().describe("A decimal number between 0 and 1, where 1 if extremely likely a real person, 0 if extremely likely if automated/service/promotion/newsletter/bookings/travel anything not real person."),
  industry: z.string().optional().describe("If unknown, null. Industry if determinable from domain"),
  contactRole: z.string().optional().describe("If unknown, null. Job Role if determinable from email prefix"),
  company: z.string().optional().describe("If unknown, null. Company name if determinable from domain")
});